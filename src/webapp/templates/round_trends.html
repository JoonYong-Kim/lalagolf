{% extends 'base.html' %}

{% block title %}Round Trends{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <h1>Round Trends</h1>

    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'generalStats')">일반 통계</button>
        <button class="tab-button" onclick="openTab(event, 'clubStats')">클럽 통계</button>
        <button class="tab-button" onclick="openTab(event, 'correlation')">상관 분석</button>
    </div>

    <div id="generalStats" class="tab-content active">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Score Range</th>
                    <th>Min GIR</th>
                    <th>Avg GIR</th>
                    <th>Max GIR</th>
                    <th>Min Putts</th>
                    <th>Avg Putts</th>
                    <th>Max Putts</th>
                    <th>Avg OB Penalties</th>
                    <th>Avg H Penalties</th>
                    <th>Birdie Ratio</th>
                    <th>Par Ratio</th>
                    <th>Bogey Ratio</th>
                    <th>Double Bogey+ Ratio</th>
                </tr>
            </thead>
            <tbody>
                {% for range_name, stats in calculated_trends.items() %}
                <tr>
                    <td>{{ range_name }}</td>
                    <td>{{ "%.1f" % stats.min_gir if stats.min_gir is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.avg_gir if stats.avg_gir is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.max_gir if stats.max_gir is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.min_putts if stats.min_putts is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.avg_putts if stats.avg_putts is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.max_putts if stats.max_putts is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.avg_ob_penalties if stats.avg_ob_penalties is not none else '-' }}</td>
                    <td>{{ "%.1f" % stats.avg_h_penalties if stats.avg_h_penalties is not none else '-' }}</td>
                    <td>{{ "%.1f" % (stats.birdie_ratio * 100) if stats.birdie_ratio is not none else '-' }}%</td>
                    <td>{{ "%.1f" % (stats.par_ratio * 100) if stats.par_ratio is not none else '-' }}%</td>
                    <td>{{ "%.1f" % (stats.bogey_ratio * 100) if stats.bogey_ratio is not none else '-' }}%</td>
                    <td>{{ "%.1f" % (stats.double_bogey_plus_ratio * 100) if stats.double_bogey_plus_ratio is not none else '-' }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="chart-container">
            <canvas id="girChart"></canvas>
            <canvas id="puttChart"></canvas>
            <canvas id="penaltyChart"></canvas>
            <canvas id="scoreRatioChart"></canvas>
        </div>
    </div>

    <div id="clubStats" class="tab-content">
        <h2>Club Statistics</h2>
        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th rowspan="2" style="vertical-align: middle;">Club Type</th>
                    {% for range_name in club_trends.keys() %}
                        <th colspan="3">{{ range_name }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for _ in club_trends.keys() %}
                        <th>A</th>
                        <th>B</th>
                        <th>C</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set club_order = ['Driver', 'Wood/Utility', 'Long Iron', 'Middle Iron', 'Short Iron', 'Wedge', 'Putter'] %}
                {% for club_type in club_order %}
                    <tr>
                        <td>{{ club_type }}</td>
                        {% for range_name in club_trends.keys() %}
                            {% set stats = club_trends[range_name][club_type] %}
                            <td>{{ "%.1f" % stats.A if stats else '0.0' }}</td>
                            <td>{{ "%.1f" % stats.B if stats else '0.0' }}</td>
                            <td>{{ "%.1f" % stats.C if stats else '0.0' }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="chart-container">
            <canvas id="clubPerformanceChart"></canvas>
        </div>
    </div>

    <div id="correlation" class="tab-content">
        <h2>Score Correlation Analysis</h2>
        <div class="chart-container">
            <canvas id="correlationChart"></canvas>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Activate the first tab by default on page load
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelector('.tab-button').click();
        });

        const calculatedTrends = {{ calculated_trends | tojson }};
        const clubTrends = {{ club_trends | tojson }};
        const correlationData = {{ correlation_data | tojson }};
        const scoreRanges = Object.keys(calculatedTrends);

        // Helper to get data for charts, handling nulls
        const getData = (key) => scoreRanges.map(range => calculatedTrends[range][key] !== null ? calculatedTrends[range][key] : 0);
        const getPercentageData = (key) => scoreRanges.map(range => calculatedTrends[range][key] !== null ? calculatedTrends[range][key] * 100 : 0);

        // GIR Chart
        const girCtx = document.getElementById('girChart').getContext('2d');
        new Chart(girCtx, {
            type: 'bar',
            data: {
                labels: scoreRanges,
                datasets: [{
                    label: 'Average GIR',
                    data: getData('avg_gir'),
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Average GIR by Score Range'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average GIR (%)'
                        }
                    }
                }
            }
        });

        // Putts Chart
        const puttCtx = document.getElementById('puttChart').getContext('2d');
        new Chart(puttCtx, {
            type: 'bar',
            data: {
                labels: scoreRanges,
                datasets: [{
                    label: 'Average Putts',
                    data: getData('avg_putts'),
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Average Putts by Score Range'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Putts'
                        }
                    }
                }
            }
        });

        // Penalty Chart
        const penaltyCtx = document.getElementById('penaltyChart').getContext('2d');
        new Chart(penaltyCtx, {
            type: 'bar',
            data: {
                labels: scoreRanges,
                datasets: [
                    {
                        label: 'Average OB Penalties',
                        data: getData('avg_ob_penalties'),
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Average H Penalties',
                        data: getData('avg_h_penalties'),
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Average Penalties by Score Range'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Penalties'
                        }
                    }
                }
            }
        });

        // Score Ratio Chart (Stacked Bar or Grouped Bar)
        const scoreRatioCtx = document.getElementById('scoreRatioChart').getContext('2d');
        new Chart(scoreRatioCtx, {
            type: 'bar',
            data: {
                labels: scoreRanges,
                datasets: [
                    {
                        label: 'Birdie',
                        data: getPercentageData('birdie_ratio'),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    },
                    {
                        label: 'Par',
                        data: getPercentageData('par_ratio'),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    },
                    {
                        label: 'Bogey',
                        data: getPercentageData('bogey_ratio'),
                        backgroundColor: 'rgba(255, 206, 86, 0.7)',
                    },
                    {
                        label: 'Double Bogey+',
                        data: getPercentageData('double_bogey_plus_ratio'),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Score Ratios by Score Range'
                    },
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Percentage (%)'
                        }
                    }
                }
            }
        });

        // Club Performance Chart
        const clubPerformanceCtx = document.getElementById('clubPerformanceChart').getContext('2d');
        const clubTypes = ['Driver', 'Wood/Utility', 'Long Iron', 'Middle Iron', 'Short Iron', 'Wedge', 'Putter'];
        const scoreRangesForClubChart = Object.keys(clubTrends);

        const gradeColors = {
            'A': 'rgba(75, 192, 192, 0.7)',
            'B': 'rgba(255, 206, 86, 0.7)',
            'C': 'rgba(255, 99, 132, 0.7)'
        };

        const datasets = [];

        scoreRangesForClubChart.forEach(range => {
            ['A', 'B', 'C'].forEach(grade => {
                const data = clubTypes.map(club => {
                    const clubData = clubTrends[range] ? clubTrends[range][club] : null;
                    return clubData ? clubData[grade] : 0;
                });

                datasets.push({
                    label: `${range} - ${grade}`,
                    data: data,
                    backgroundColor: gradeColors[grade],
                    stack: range
                });
            });
        });

        new Chart(clubPerformanceCtx, {
            type: 'bar',
            data: {
                labels: clubTypes,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Club Performance by Score Range (Avg Shots per Round)'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {},
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Shots per Round'
                        }
                    }
                }
            }
        });

        // Correlation Chart
        const correlationCtx = document.getElementById('correlationChart').getContext('2d');
        const correlationLabels = Object.keys(correlationData);
        const correlationValues = Object.values(correlationData);
        const correlationBackgroundColors = correlationValues.map(value => value > 0 ? 'rgba(255, 99, 132, 0.5)' : 'rgba(75, 192, 192, 0.5)');
        const correlationBorderColors = correlationValues.map(value => value > 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)');

        new Chart(correlationCtx, {
            type: 'bar',
            data: {
                labels: correlationLabels,
                datasets: [{
                    label: 'Correlation with Score',
                    data: correlationValues,
                    backgroundColor: correlationBackgroundColors,
                    borderColor: correlationBorderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Correlation of Various Stats with Final Score'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(3);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Correlation Coefficient'
                        }
                    }
                }
            }
        });
    </script>
{% endblock %}
