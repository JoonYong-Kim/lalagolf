{% extends 'base.html' %}

{% block title %}Round Details{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <h1>Round on {{ round_info.playdate.strftime('%Y-%m-%d') }}</h1>

    <div class="round-navigation">
        {% if comparison_stats.prev_round %}
            <a href="{{ url_for('round_detail', round_id=comparison_stats.prev_round.id) }}">&laquo; Previous Round</a>
        {% endif %}
        {% if comparison_stats.next_round %}
            <a href="{{ url_for('round_detail', round_id=comparison_stats.next_round.id) }}">Next Round &raquo;</a>
        {% endif %}
    </div>

    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'roundOverview')">라운드 개요</button>
        <button class="tab-button" onclick="openTab(event, 'holeDetails')">홀별 상세</button>
        <button class="tab-button" onclick="openTab(event, 'shotStatistics')">샷 통계</button>
        <button class="tab-button" onclick="openTab(event, 'clubStatistics')">클럽 통계</button>
        <button class="tab-button" onclick="openTab(event, 'roundComparison')">라운드 비교</button>
        <button class="tab-button" onclick="openTab(event, 'rawData')">Raw Data</button>
    </div>

    <div id="roundOverview" class="tab-content active">
        <p><strong>Golf Course:</strong> {{ round_info.gcname }}</p>
        <p><strong>Tee-off Time:</strong> {{ round_info.playdate.strftime('%Y-%m-%d %H:%M') }}</p>
        <p><strong>Co-players:</strong> {{ round_info.coplayers }}</p>
        <p><strong>Score:</strong> {{ round_info.score }}</p>
        <p><strong>GIR:</strong> {{ "%.1f" % round_info.gir }}%</p>
    </div>

    <div id="holeDetails" class="tab-content">
        <h2>Holes</h2>
        <div class="row">
            <div class="col-md-6">
                <h5>Front Nine</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Hole</th>
                            {% for i in range(1, 10) %}
                            <th>{{ i }}</th>
                            {% endfor %}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Par</td>
                            {% for hole in holes_info[0]%}
                            <td>{{ hole.par }}</td>
                            {% endfor %}
                            <td>{{ holes_info[0] | sum(attribute='par') }}</td>
                        </tr>
                        <tr>
                            <td>Score</td>
                            {% for hole in holes_info[0]%}
                            <td>{{ hole.diff}}</td>
                            {% endfor %}
                            <td>{{ holes_info[0] | sum(attribute='diff') }}</td>
                        </tr>
                        <tr>
                            <td>Putt</td>
                            {% for hole in holes_info[0]%}
                            <td>{{ hole.putt}}</td>
                            {% endfor %}
                            <td>{{ holes_info[0] | sum(attribute='putt') }}</td>
                        </tr>
                        <tr>
                            <td>GIR</td>
                            {% for hole in holes_info[0] %}
                            <td>{{ 'O' if hole.GIR else 'X' }}</td>
                            {% endfor %}
                            <td>{{ "%.1f" % ((holes_info[0] | selectattr('GIR') | list | count / (holes_info[0] | length if holes_info[0] | length > 0 else 1)) * 100) }}%</td>
                        </tr>
                        <tr>
                            <td>GIR1</td>
                            {% for hole in holes_info[0] %}
                            <td>{{ 'O' if hole.GIR1 else 'X' }}</td>
                            {% endfor %}
                            <td>{{ "%.1f" % ((holes_info[0] | selectattr('GIR1') | list | count / (holes_info[0] | length if holes_info[0] | length > 0 else 1)) * 100) }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h5>Back Nine</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Hole</th>
                            {% for i in range(10, 19) %}
                            <th>{{ i }}</th>
                            {% endfor %}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Par</td>
                            {% for hole in holes_info[1] %}
                            <td>{{ hole.par }}</td>
                            {% endfor %}
                            <td>{{ holes_info[1] | sum(attribute='par') }}</td>
                        </tr>
                        <tr>
                            <td>Score</td>
                            {% for hole in holes_info[1] %}
                            <td>{{ hole.diff}}</td>
                            {% endfor %}
                            <td>{{ holes_info[1] | sum(attribute='diff') }}</td>
                        </tr>
                        <tr>
                            <td>Putt</td>
                            {% for hole in holes_info[1] %}
                            <td>{{ hole.putt}}</td>
                            {% endfor %}
                            <td>{{ holes_info[1] | sum(attribute='putt') }}</td>
                        </tr>
                        <tr>
                            <td>GIR</td>
                            {% for hole in holes_info[1] %}
                            <td>{{ 'O' if hole.GIR else 'X' }}</td>
                            {% endfor %}
                            <td>{{ "%.1f" % ((holes_info[1] | selectattr('GIR') | list | count / (holes_info[1] | length if holes_info[1] | length > 0 else 1)) * 100) }}%</td>
                        </tr>
                        <tr>
                            <td>GIR1</td>
                            {% for hole in holes_info[1] %}
                            <td>{{ 'O' if hole.GIR1 else 'X' }}</td>
                            {% endfor %}
                            <td>{{ "%.1f" % ((holes_info[1] | selectattr('GIR1') | list | count / (holes_info[1] | length if holes_info[1] | length > 0 else 1)) * 100) }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% if holes_info[2] %}
        <div class="row">
            <div class="col-md-6">
                <h5>Extra Nine</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Hole</th>
                            {% for i in range(19, 28) %}
                            <th>{{ i }}</th>
                            {% endfor %}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Par</td>
                            {% for hole in holes_info[2] %}
                            <td>{{ hole.par }}</td>
                            {% endfor %}
                            <td>{{ holes_info[2] | sum(attribute='par') }}</td>
                        </tr>
                        <tr>
                            <td>Score</td>
                            {% for hole in holes_info[2] %}
                            <td>{{ hole.diff}}</td>
                            {% endfor %}
                            <td>{{ holes_info[2] | sum(attribute='diff') }}</td>
                        </tr>
                        <tr>
                            <td>Putt</td>
                            {% for hole in holes_info[2] %}
                            <td>{{ hole.putt}}</td>
                            {% endfor %}
                            <td>{{ holes_info[2] | sum(attribute='putt') }}</td>
                        </tr>
                        <tr>
                            <td>GIR</td>
                            {% for hole in holes_info[2] %}
                            <td>{{ "%.1f" % (hole.GIR * 100) }}%</td>
                            {% endfor %}
                            <td>{{ "%.1f" % ((holes_info[2] | selectattr('GIR') | list | count / (holes_info[2] | length if holes_info[2] | length > 0 else 1)) * 100) }}%</td>
                        </tr>
                        <tr>
                            <td>GIR1</td>
                            {% for hole in holes_info[2] %}
                            <td>{{ "%.1f" % (hole.GIR1 * 100) }}%</td>
                            {% endfor %}
                            <td>{{ "%.1f" % ((holes_info[2] | selectattr('GIR1') | list | count / (holes_info[2] | length if holes_info[2] | length > 0 else 1)) * 100) }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div id="shotStatistics" class="tab-content">
        <h3 class="mt-4">Detailed Shot Statistics</h3>
        <div class="row">
            <div class="col-md-6">
                <h5>Penalty & Concede Stats</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr><th>Type</th><th>Count</th><th>Percentage</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Hazard (H)</td><td>{{ detailed_shot_stats.raw_stats.H }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.H * 100) }}%</td></tr>
                        <tr><td>Out of Bounds (OB)</td><td>{{ detailed_shot_stats.raw_stats.OB }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.OB * 100) }}%</td></tr>
                        <tr><td>Unplayable (UN)</td><td>{{ detailed_shot_stats.raw_stats.UN }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.UN * 100) }}%</td></tr>
                        <tr><td>Conceded (OK)</td><td>{{ detailed_shot_stats.raw_stats.OK }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.OK * 100) }}%</td></tr>
                        <tr><td>Wedge Conceded (WOK)</td><td>{{ detailed_shot_stats.raw_stats.WOK }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.WOK * 100) }}%</td></tr>
                    </tbody>
                </table>
                <div class="chart-container">
                    <canvas id="penaltyChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h5>Feel-Result Combinations</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr><th>Combination</th><th>Count</th><th>Percentage</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Normal Shots</td><td>{{ detailed_shot_stats.raw_stats.SA }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.SA * 100) }}%</td></tr>
                        <tr><td>Bad Management</td><td>{{ detailed_shot_stats.raw_stats.BT }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.BT * 100) }}%</td></tr>
                        <tr><td>Lucky Shots</td><td>{{ detailed_shot_stats.raw_stats.WS }}</td><td>{{ "%.1f" % (detailed_shot_stats.relative_stats.WS * 100) }}%</td></tr>
                    </tbody>
                </table>
                <div class="chart-container">
                    <canvas id="feelResultChart"></canvas>
                </div>
                <h5>Bunker Stats</h5>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr><th>Type</th><th>Percentage</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Bunker Shots</td><td>{{ "%.1f" % (detailed_shot_stats.bunker_stats.B * 100) }}%</td></tr>
                        <tr><td>Exited Sand Bunker (ESB)</td><td>{{ "%.1f" % (detailed_shot_stats.bunker_stats.ESB * 100) }}%</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h2>Shots</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Hole</th>
                    <th>Club</th>
                    <th>Feel</th>
                    <th>Result</th>
                    <th>Distance</th>
                    <th>Penalty</th>
                    <th>Concede</th>
                    <th>Retplace</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody>
            {% for shot in shots %}
                <tr>
                    <td>{{ shot.holenum }}</td>
                    <td>{{ shot.club }}</td>
                    <td>{{ shot.feel }}</td>
                    <td>{{ shot.result }}{{ ',' + shot.eresult if shot.eresult else ''}}</td>
                    <td>{{ shot.distance }}</td>
                    <td>{{ shot.penalty if shot.penalty else '-' }}</td>
                    <td>{{ 'Yes' if shot.concede else 'No' }}</td>
                    <td>{{ shot.retplace if shot.retplace else '-' }}</td>
                    <td>{{ shot.error if shot.error is not none else '-' }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="clubStatistics" class="tab-content">
        <h5 class="mt-4">Club Feel Statistics (A/B/C Percentages)</h5>
        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th>Club Type</th>
                    <th>A (%)</th>
                    <th>B (%)</th>
                    <th>C (%)</th>
                    <th>Penalty (%)</th>
                    <th>Total Usage (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for club_type, stats in detailed_shot_stats.club_feel_stats.items() %}
                <tr>
                    <td>{{ club_type }}</td>
                    <td>{{ "%.1f" % (stats.A * 100) }}</td>
                    <td>{{ "%.1f" % (stats.B * 100) }}</td>
                    <td>{{ "%.1f" % (stats.C * 100) }}</td>
                    <td>{{ "%.1f" % (stats.P * 100) }}</td>
                    <td>{{ "%.1f" % (stats.total_percentage * 100) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="chart-container">
            <canvas id="clubChart"></canvas>
        </div>
    </div>

    <div id="roundComparison" class="tab-content">
        <h3>Round Comparison</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Stat</th>
                    <th>This Round</th>
                    <th>Overall Avg.</th>
                    <th>Same Course Avg.</th>
                    <th>Recent 5 Avg.</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Score</td>
                    <td>{{ "%.1f" % round_info.score }}</td>
                    <td>{{ "%.1f" % comparison_stats.overall.avg_score }}</td>
                    <td>{{ "%.1f" % comparison_stats.same_course.avg_score }}</td>
                    <td>{{ "%.1f" % comparison_stats.recent_5.avg_score }}</td>
                </tr>
                <tr>
                    <td>GIR</td>
                    <td>{{ "%.1f" % round_info.gir }}%</td>
                    <td>{{ "%.1f" % comparison_stats.overall.avg_gir }}%</td>
                    <td>{{ "%.1f" % comparison_stats.same_course.avg_gir }}%</td>
                    <td>{{ "%.1f" % comparison_stats.recent_5.avg_gir }}%</td>
                </tr>
                <tr>
                    <td>Putts</td>
                    <td>{{ holes_info[0] | sum(attribute='putt') + holes_info[1] | sum(attribute='putt') + holes_info[2] | sum(attribute='putt') }}</td>
                    <td>{{ "%.1f" % comparison_stats.overall.avg_putt }}</td>
                    <td>{{ "%.1f" % comparison_stats.same_course.avg_putt }}</td>
                    <td>{{ "%.1f" % comparison_stats.recent_5.avg_putt }}</td>
                </tr>
            </tbody>
        </table>

        <h3>Personal Best</h3>
        <p><strong>Best Score:</strong> {{ comparison_stats.personal_best.best_score }}</p>
        <p><strong>Best GIR:</strong> {{ "%.1f" % comparison_stats.personal_best.best_gir }}%</p>

        <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>

    <div id="rawData" class="tab-content">
        {% if session.logged_in %}
        <form action="{{ url_for('update_round_raw_data', round_id=round_info.id) }}" method="post">
            <div class="form-group">
                <label for="raw_data_content">Raw Data:</label>
                <textarea class="form-control" id="raw_data_content" name="raw_data_content" rows="20">{{ round_info.raw_data }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary mt-3 custom-btn">Save Raw Data</button>
        </form>
        {% else %}
        <p>Please log in to view and edit raw data.</p>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Activate the first tab by default on page load
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelector('.tab-button').click();
        });

        const clubCtx = document.getElementById('clubChart').getContext('2d');
        new Chart(clubCtx, {
            type: 'pie',
            data: {
                labels: {{ club_labels | tojson }},
                datasets: [{
                    label: 'Club Usage',
                    data: {{ club_data | tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            }
        });

        // Penalty Chart
        const penaltyCtx = document.getElementById('penaltyChart').getContext('2d');
        new Chart(penaltyCtx, {
            type: 'bar',
            data: {
                labels: ['Hazard (H)', 'Out of Bounds (OB)', 'Unplayable (UN)', 'Conceded (OK)', 'Wedge Conceded (WOK)'],
                datasets: [{
                    label: 'Penalty & Concede Counts',
                    data: [
                        {{ detailed_shot_stats.raw_stats.H | tojson }},
                        {{ detailed_shot_stats.raw_stats.OB | tojson }},
                        {{ detailed_shot_stats.raw_stats.UN | tojson }},
                        {{ detailed_shot_stats.raw_stats.OK | tojson }},
                        {{ detailed_shot_stats.raw_stats.WOK | tojson }}
                    ],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Feel-Result Chart
        const feelResultCtx = document.getElementById('feelResultChart').getContext('2d');
        new Chart(feelResultCtx, {
            type: 'bar',
            data: {
                labels: ['Normal Shots', 'Bad Management', 'Lucky Shots'],
                datasets: [{
                    label: 'Feel-Result Combinations',
                    data: [
                        {{ detailed_shot_stats.raw_stats.SA | tojson }},
                        {{ detailed_shot_stats.raw_stats.BT | tojson }},
                        {{ detailed_shot_stats.raw_stats.WS | tojson }}
                    ],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Comparison Chart
        const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
        new Chart(comparisonCtx, {
            type: 'bar',
            data: {
                labels: ['Score', 'GIR', 'Putts'],
                datasets: [
                    {
                        label: 'This Round',
                        data: [
                            {{ round_info.score | tojson }},
                            {{ round_info.gir | tojson }},
                            {{ (holes_info[0] | sum(attribute='putt') + holes_info[1] | sum(attribute='putt') + holes_info[2] | sum(attribute='putt')) | tojson }}
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Overall Avg.',
                        data: [
                            {{ comparison_stats.overall.avg_score | tojson }},
                            {{ comparison_stats.overall.avg_gir | tojson }},
                            {{ comparison_stats.overall.avg_putt | tojson }}
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
{% endblock %}
